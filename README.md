# Financial Calculator — Native Walk UI (Canonical)

This repository delivers a Windows-native desktop Financial Calculator using the Walk toolkit. The previous Wails/React UI remains checked in for legacy reference but is not maintained or tested. Build and use the Walk UI for all current work.

- Canonical UI: Walk (Windows-native)
- Legacy UI: Wails/React (unmaintained; ignore unless explicitly needed)

Contents
- 1. Quickstart (Walk UI)
- 2. Project layout
- 3. Engines API (thorough endpoint overview)
- 4. Walk UI mapping to Engines
- 5. What’s implemented vs. TODOs
- 6. Legacy Wails UI (ignore for now)

---

## 1) Quickstart (Walk UI)

Requirements
- Windows 10/11
- Go (1.21+; repo currently set to 1.23 at root)
- MSVC redistributables (typical Windows dev machine has these)

Build and run Walk (native GUI)
- Quick dev (no resource embedding):
  - go run -tags walkui .
- Build with GUI subsystem and embedded manifest/version info:
  1) Install goversioninfo (one time):
     - go install github.com/josephspurrier/goversioninfo/cmd/goversioninfo@latest
  2) Generate resource and build:
     - & "$env:USERPROFILE\go\bin\goversioninfo.exe"
     - go build -tags walkui -ldflags "-H=windowsgui" -o walk/fc-walk.exe .
  3) Run:
     - ./walk/fc-walk.exe

Notes
- If you see side-by-side errors launching the EXE, re-run the resource generation step before building. The manifest files used for Walk live in walk/build/windows.
- For quick iteration, go run -tags walkui . is fastest (no resource embedding).

---

## 2) Project layout

- walk/ (all Walk-related build artefacts and metadata)
  - fc-walk.exe (native Windows app binary; generated by build)
  - walk_manifest.syso (generated resource file if used)
  - versioninfo.json (resource config: versioning, icon, manifest path)
  - build/windows/walk.exe.manifest (activates ComCtl v6, DPI awareness)
- frontend/ (legacy Wails/React UI — ignore unless explicitly needed)
- engines/ (Go engines — core business logic)
  - calculator/ (Orchestrates the full pipeline)
  - pricing/ (Installment, rate solving, amortization schedule)
  - cashflow/ (T0 flows, schedules, IRR/EAR, nominal/effective rate conversions)
  - campaigns/ (Stacking and application of marketing campaigns)
  - profitability/ (Profitability waterfall to Acquisition RoRAC)
  - types/ (Shared entity and DTO definitions)
- parameters/ (parameter cache/service used by Wails main; not used in Walk UI yet)
- app.go (Wails app bindings — legacy)
- main.go (Wails entrypoint — legacy)
- walk_main.go (Walk entrypoint source; compiled via -tags walkui; kept at repo root for package-main linkage)
- docs/
  - financial-calculator-architecture.md (additional specs; see section 14 for Walk migration notes)

Rationale for walk_main.go at repo root
- Go cannot import “package main” from a subdirectory. Our Walk entrypoint needs to be in the same package for now. A future refactor will extract the Wails bindings into an importable package (e.g., internal/app), then move the Walk entrypoint fully under /walk. All other Walk artefacts have been moved under /walk already.

---

## 3) Engines API (thorough endpoint overview)

The engines are structured to be called programmatically and return deterministic results. All rates are decimals and amounts are in THB with explicit rounding.

Types (engines/types)
- Product: "HP", "mySTAR", "F-Lease", "Op-Lease"
- PaymentTiming: "arrears" | "advance"
- CampaignType: "subdown" | "subinterest" | "free_insurance" | "free_mbsp" | "cash_discount"
- IDCTiming: "upfront" | "periodic"
- IDCCategory: "documentation_fee" | "acquisition_fee" | "broker_commission" | "stamp_duty" | "internal_processing" | "admin_fee" | "maintenance_fee"
- CashflowType: "principal" | "interest" | "fee" | "subsidy" | "disbursement" | "down_payment" | "balloon"

Core structs
- Deal
  - Market, Currency, Product, PriceExTax, DownPaymentAmount, DownPaymentPercent, DownPaymentLocked ("amount"|"percent")
  - FinancedAmount, TermMonths, BalloonPercent/Amount
  - Timing, PayoutDate, FirstPaymentOffset
  - RateMode ("fixed_rate"|"target_installment"), CustomerNominalRate, TargetInstallment
- Campaign
  - ID, Type, Eligibility, Funder, Stacking; type-specific fields like SubsidyPercent, TargetRate, etc.
- IDCItem
  - Category, Amount, Payer, Financed, Withheld, Timing, TaxFlags, IsRevenue, IsCost, Description
- ParameterSet
  - CostOfFundsCurve, MatchedFundedSpread, PDLGD map, OPEXRates, EconomicCapitalParams, CentralHQAddOn, RoundingRules, DayCountConvention
- Cashflow (date, direction, type, amount, memo, optional principal/interest/balance)
- ProfitabilityWaterfall
  - DealIRREffective/Nominal, CostOfDebtMatched, MF Spread, GrossInterestMargin, CapitalAdvantage, NetInterestMargin, CostOfCreditRisk, OPEX, IDC impacts (upfront/periodic), NetEBITMargin, EconomicCapital, AcquisitionRoRAC
- CalculationRequest/CalculationResult/Quote

Helper functions
- RoundTHB(amount) → whole THB
- RoundBasisPoints(rate) → 4 dp
- AddMonths(date, n), MonthsBetween(start, end), DaysInYear()

Calculator (engines/calculator)
- New(parameterSet types.ParameterSet) → *Calculator
- Calculate(request types.CalculationRequest) → (*types.CalculationResult, error)
- CalculateWithDefaults(deal, campaigns, idc) → (*types.CalculationResult, error)
- GetPerformanceMetrics(result) → map[string]interface{}
- Internals (used by Calculate): processDeal (pricing + cashflow + profitability), calculateFinancedAmount, validateRequest, generateHash

Pricing (engines/pricing)
- NewEngine(params) → *Engine
- CalculateInstallment(principal, annualRate, termMonths, balloonAmount) → (installment, error)
- SolveForRate(principal, targetInstallment, termMonths, balloonAmount) → (annualRate, error)
- BuildAmortizationSchedule(deal, nominalRate) → ([]types.Cashflow, error)
- ProcessDeal(deal) → (*PricingResult, error)
- CalculateEffectiveRate(nominal, compoundingPeriods) → effective
- CalculateNominalRate(effective, compoundingPeriods) → nominal
- ValidateDeal(deal) → []error

Cashflow (engines/cashflow)
- NewEngine(params) → *Engine
- ConstructT0Flows(deal, campaignFlows, idcItems) → []types.Cashflow
- BuildPeriodicSchedule(deal, installment, nominalRate) → []types.Cashflow
- AddBalloonPayment(deal, schedule) → []types.Cashflow
- CalculateMonthlyIRR(cashflows) → (monthlyIRR, error)
- CalculateEffectiveAnnualRate(monthlyIRR) → effectiveAnnual
- CalculateNominalRate(effectiveAnnual, compoundingPeriods) → nominal
- SolveForNominalRate(principal, targetInstallment, termMonths, balloonAmount) → (annualRate, error)
- MergeCashflows(streams...) → []types.Cashflow
- CalculateDealIRR(t0, schedule, periodicIDC) → (effectiveAnnual, error)

Campaigns (engines/campaigns)
- NewEngine(params) → *Engine
- ApplyCampaigns(deal, []Campaign) → (*CampaignResult, error)
  - Applies in stack order: Subdown → Subinterest → Free Insurance → Free MBSP → Cash Discount
  - Returns TransformedDeal, T0Flows (e.g., subsidies), AuditEntries, TotalImpact
- ValidateCampaignEligibility(deal, campaign) → bool

Profitability (engines/profitability)
- NewEngine(params) → *Engine
- CalculateWaterfall(deal, dealIRR, idcUpfrontNet, idcPeriodicNet) → (*ProfitabilityWaterfall, error)
- CalculateIDCImpact(idcItems) → (upfrontNet, periodicNet)   [MVP returns zeros; extend later]
- GenerateWaterfallSummary(waterfall) → map[string]string
- ValidateParameters() → []error

---

## 4) Mapping to Walk UI (implemented)

Walk UI lives in the root source [walk_main.go] and compiles under the `walkui` build tag. It wires inputs to a single recalculation function which calls the existing Go pipeline and updates the screen.

Inputs (Left pane)
- Product: ComboBox ("HP", "mySTAR", "FinanceLease", "OperatingLease")
- Price ex tax (THB): LineEdit
- Down payment percent + amount: linked via a lock mode (Percent/Amount)
- Term (months): LineEdit
- Timing: ComboBox ("Arrears", "Advance")
- Balloon percent (%): LineEdit
- Rate mode:
  - Fixed rate: enable “Customer rate (% p.a.)”
  - Target installment: enable “Target installment (THB)”
- Calculate button triggers recompute; also recompute on EditingFinished changes

Outputs (Right pane)
- Key metrics:
  - Monthly Installment (THB)
  - Customer Rate Nominal (%)
  - Customer Rate Effective (%)
  - Acquisition RoRAC (%)
  - Financed Amount (THB)
- Metadata:
  - Parameter Version (from engine result; Walk UI currently uses a default set baked by backend)
  - Calculated timestamp

Calculation pipeline used by Walk
- Deals are converted to the input arguments of the orchestrator equivalent behind the scenes (mirrors Wails flow).
- Engines invoked in order:
  - Campaigns.ApplyCampaigns (stacked)
  - Pricing.ProcessDeal (installment or solve for rate)
  - Cashflow (T0 flows + periodic schedule + IRR/EAR)
  - Profitability.CalculateWaterfall (RoRAC)
- Outputs are formatted and shown in labels.

---

## 5) Implemented vs. TODOs (Walk)

Implemented
- Split-pane Walk window with clean, non-overlapping layout
- Core input set: product, price, DP %/amount with lock, term, timing, balloon, rate mode
- Core output metrics and metadata
- Quick run and packaged build with Windows GUI subsystem
- Manifest and version resource embedded for robust SxS behavior

Planned / TODO
- IDC UX: modal/table editor; pass serialized IDC list to engines
- Campaign selection: chips/checkboxes; pass []types.Campaign to engines; audit visible
- Advanced dates: payout date picker; first payment offset editor
- Waterfall details view: expandable section with all component lines
- Save/export scenario (JSON) from Walk UI; scenario compare view
- Parameter service integration in Walk:
  - Load latest parameter set via parameters.Service with conversion into engines/types
  - Offline cache indicator and version label (current label wired to engine output metadata)
- Finish package separation so Walk entrypoint moves fully into /walk without relying on root-main build linkage

---

## 6) Legacy Wails UI

The Wails/React/Tailwind frontend under /frontend remains for historical reference. It is not tested and should be ignored for normal workflows. If needed temporarily:
- Live dev: wails dev
- Build: wails build

Note: The Walk UI is the canonical path for MVP and ongoing development.
